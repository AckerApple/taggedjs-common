var e={d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};function r(e){return n(e,new WeakMap)}function n(e,t){if(null===e||"object"!=typeof e)return e;if(t.has(e))return t.get(e);if(e instanceof Date)return new Date(e);if(e instanceof RegExp)return new RegExp(e);const r=Array.isArray(e)?[]:Object.create(Object.getPrototypeOf(e));if(t.set(e,r),Array.isArray(e))for(let o=0;o<e.length;o++)r[o]=n(e[o],t);else for(const o in e)e.hasOwnProperty(o)&&(r[o]=n(e[o],t));return r}function o(e,t){return a(e,t,new WeakMap)}function a(e,t,r){if(e===t||(o=t,(n=e)instanceof Function&&o instanceof Function&&n.toString()===o.toString()))return!0;var n,o;if("object"!=typeof e||"object"!=typeof t||null===e||null===t)return!1;const s=Object.keys(e),l=Object.keys(t);if(s.length!==l.length)return!1;if(r.has(e))return!0;r.set(e,0);for(const n of s)if(!l.includes(n)||!a(e[n],t[n],r))return!1;if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return!1;for(let n=0;n<e.length;n++)if(!a(e[n],t[n],r))return!1}else if(Array.isArray(e)||Array.isArray(t))return!1;return!0}function s(e){return!0===e?.isTag}e.d(t,{xH:()=>z,Ly:()=>Z,TY:()=>B});class l{templater;subject;isApp=!0;propsConfig;memory={state:{newest:[]}};constructor(e,t){this.templater=e,this.subject=t;const n=this.templater.children,o=this.templater.props,a=r(o);this.propsConfig={latest:o,latestCloned:a,clonedProps:a,lastClonedKidValues:n.value.map((e=>i(e.values)))},s(o)||(this.propsConfig.latestCloned=r(a),this.propsConfig.clonedProps=this.propsConfig.latestCloned)}}function i(e){return e.map((e=>{const t=e;return s(t)?i(t.values):function(e){return!0===e?.isTemplater}(t)?r(t.props):function(e){return e instanceof Array&&e.every((e=>s(e)))}(t)?i(t):r(e)}))}class c extends Error{details;constructor(e,t,r={}){super(e),this.name=c.name,this.details={...r,errorCode:t}}}class u extends c{constructor(e,t){super(e,"state-mismatch-error",t),this.name=u.name}}class p extends c{constructor(e,t){super(e,"sync-callback-error",t),this.name=p.name}}function g(e){const t={beforeRender:e.beforeRender||(()=>{}),beforeRedraw:e.beforeRedraw||(()=>{}),afterRender:e.afterRender||(()=>{}),beforeDestroy:e.beforeDestroy||(()=>{})};g.tagUse.push(t)}g.tagUse=[],g.memory={},g.memory.stateConfig={array:[]};const f=e=>function(e){const t=e.memory.state,r=g.memory.stateConfig;if(r.rearray){const n="last state not cleared. Possibly in the middle of rendering one component and another is trying to render";throw console.error(n,{config:r,component:e.templater?.wrapper.original,wasInMiddleOf:r.tagSupport?.templater.wrapper.original,state:t,expectedClearArray:r.rearray}),new u(n,{config:r,component:e.templater?.wrapper.original,state:t,expectedClearArray:r.rearray})}r.rearray=[],t?.newest.length&&(t.newest.map((e=>d(e))),r.rearray.push(...t.newest)),r.tagSupport=e}(e);function d(e){const t=e.callback;if(!t)return e.defaultValue;const r=t(b),[n]=r,[o]=t(n);if(o!==b){const a='State property not used correctly. Second item in array is not setting value as expected.\n\nFor "let" state use `let name = state(default)(x => [name, name = x])`\n\nFor "const" state use `const name = state(default)()`\n\nProblem state:\n'+(t?t.toString():JSON.stringify(e))+"\n";throw console.error(a,{state:e,callback:t,oldState:r,oldValue:n,checkValue:o}),new Error(a)}return n}g({beforeRender:f,beforeRedraw:f,afterRender:e=>{const t=e.memory.state,r=g.memory.stateConfig,n=r.rearray;if(n.length&&n.length!==r.array.length){const t=`States lengths has changed ${n.length} !== ${r.array.length}. Typically occurs when a function is intended to be wrapped with a tag() call`,o={oldStates:r.array,newStates:r.rearray,component:e.templater?.wrapper.original},a=new u(t,o);throw console.warn(t,o),a}delete r.rearray,t.newest=r.array,t.newest.forEach((e=>e.lastValue=d(e))),r.array=[]}});class b{}function m(e,t){const r=g.memory.providerConfig;r.ownerTag=t,e.templater.global.providers.length&&(r.providers.length=0,r.providers.push(...e.templater.global.providers))}function h(e){e.tagSupport.templater.global.providers.filter((e=>!o(e.instance,e.clone))).forEach((t=>{!function(e,t){w(e,t).forEach((({tag:e,renderCount:t,provider:n})=>{e.tagSupport.templater.global.deleted||t===e.tagSupport.templater.global.renderCount&&(n.clone=r(n.instance),v(e.tagSupport,!1))}))}(e.getAppElement(),t),t.clone=r(t.instance)}))}function w(e,t,r=[]){const n=e.tagSupport.templater.global,o=n.providers.find((e=>e.constructMethod===t.constructMethod));return o&&r.push({tag:e,renderCount:n.renderCount,provider:o}),e.childTags.forEach((e=>w(e,t,r))),r.forEach((({tag:e})=>{if(e.tagSupport.templater.global.deleted)throw new Error("do not get here - 0")})),r}function y(e,t){return e.strings.length===t.strings.length&&(!!e.strings.every(((e,r)=>t.strings[r]===e))&&(e.values.length===t.values.length&&!!t.values.every(((t,r)=>{const n=e.values[r];return!(t instanceof Function&&n instanceof Function)||!(t.toString()!==n.toString())}))))}function v(e,t){const r=e.templater.global;if(s(e.templater)){const e=r.newest.ownerTag;return++r.renderCount,v(e.tagSupport,!0)}const n=e.subject,a=e.templater,l=n.tag,i=l?.tagSupport.templater.global.newest;let c,u=!1;t&&i&&(c=i.ownerTag,c)&&(u=!o(a.props,i.tagSupport.propsConfig.latestCloned));const p=r.newest?.tagSupport;if(!a.global.oldest)throw new Error("already causing trouble");const f=function(e,t,r,n){const o=n.tag;if(t.global=o.tagSupport.templater.global,!e.hasLiveElements)throw new Error("1080 - should have live elements");const a=r.templater.global.renderCount;h(e);const s=r.templater.global.newest;if(a!==r.templater.global.renderCount)return e.updateByTag(s),s;const l=r.templater||t,i=n.tag||l.global.newest||l.global.oldest,c=function(e,t,r,n){const o=e,a=t?.ownerTag||n;if(t)o.memory.state.newest=[...t.tagSupport.memory.state.newest],o.templater.global=t.tagSupport.templater.global,function(e,t){g.tagUse.forEach((r=>r.beforeRedraw(e,t)))}(o,t);else{if(!o)throw new Error("63521");$(o,a),g.memory.providerConfig.ownerTag=a}const s=o.templater,l=s.wrapper(o,r);return F(o,l),!t||y(t,l)||function(e,t,r){const n=e.tagSupport.templater.global.insertBefore;(function(e,t){const r=e.tagSupport;if(t!=r.subject)throw new Error("fff - subjects do not match");delete t.tag,delete r.subject.tag,r.templater.global.oldest.destroy(),function(e){delete e.templater.global.oldest,delete e.templater.global.newest}(r),r.templater.global.context={}})(e,r),t.global={...t.global};const o=t.global;o.insertBefore=n,o.deleted=!1,delete o.oldest,delete o.newest,delete r.tag}(t,s,r),l.ownerTag=a,o.templater.global.newest=l,l}(t.tagSupport,i,n,e.ownerTag),u=r.templater.global.oldest||e;return c.tagSupport.templater.global.oldest=u,y(s,c)&&(n.tag=c,u.updateByTag(c)),c}(a.global.oldest,a,p,n);return c&&u?(v(c.tagSupport,!0),f):f}g.memory.providerConfig={providers:[],ownerTag:void 0},g({beforeRender:(e,t)=>{m(e,t)},beforeRedraw:(e,t)=>{m(e,t.ownerTag)},afterRender:e=>{const t=g.memory.providerConfig;e.templater.global.providers=[...t.providers],t.providers.length=0}});let S=e=>(e,t,r,n,o,a)=>{throw new p("Callback function was called immediately in sync and must instead be call async")};const C=S;function E(e,t){e.forEach(((e,r)=>{const n=d(e),o=t[r].callback;o&&o(n),t[r].lastValue=n}))}function A(e){const t=g.memory.stateConfig.array;S=r=>(...n)=>function(e,t,r,...n){const o=e.memory.state.newest;E(o,r);const a=t(...n);E(r,o),v(e,!1),a instanceof Promise&&a.finally((()=>{E(r,o),v(e,!1)}))}(e,r,t,...n)}function T(e){g.memory.initCurrentTemplater=e.templater}let x;g({beforeRender:e=>A(e),beforeRedraw:e=>A(e),afterRender:e=>{S=C}}),g({beforeRender:e=>T(e),beforeRedraw:e=>T(e)}),g({beforeRender:e=>x=e,beforeRedraw:e=>x=e,beforeDestroy:(e,t)=>{const r=e.templater.global.destroyCallback;r&&r()}});class R{value;onSubscription;methods=[];isSubject=!0;subscribers=[];subscribeWith;constructor(e,t){this.value=e,this.onSubscription=t}subscribe(e){const t=function(e,t){const r=j.globalSubCount$;j.globalSubCount$.set(r.value+1);const n=()=>{n.unsubscribe()};return n.callback=t,n.subscriptions=[],n.unsubscribe=()=>(k(e.subscribers,t),k(j.globalSubs,t),j.globalSubCount$.set(r.value-1),n.unsubscribe=()=>n,n.subscriptions.forEach((e=>e.unsubscribe())),n),n.add=e=>(n.subscriptions.push(e),n),n.next=e=>{t(e,n)},n}(this,e),r=this.subscribeWith;if(r){if(this.methods.length){const r=e;e=e=>{O(e,this.methods,(e=>r(e,t)))}}return r(e)}return this.subscribers.push(t),j.globalSubs.push(t),this.onSubscription&&this.onSubscription(t),t}set(e){this.value=e,this.subscribers.forEach((t=>{t.callback(e,t)}))}next=this.set;toPromise(){return new Promise(((e,t)=>{this.subscribe(((t,r)=>{r.unsubscribe(),e(t)}))}))}toCallback(e){this.subscribe(((t,r)=>{r.unsubscribe(),e(t)}))}pipe(...e){const t=new R;return t.methods=e,t.subscribeWith=e=>this.subscribe(e),t}}function k(e,t){const r=e.findIndex((e=>e.callback===t));-1!==r&&e.splice(r,1)}const j=R;function O(e,t,r){const n=[...t],o=n.shift(),a=e=>{if(n.length)return O(e,n,r);r(e)};let s=a;const l=o(e,{setHandler:e=>s=e,next:a});s(l)}j.globalSubs=[],j.globalSubCount$=new R,j.globalSubCount$.set(0);class M extends R{value;constructor(e){super(e),this.value=e}subscribe(e){const t=super.subscribe(e);return e(this.value,t),t}}const P=new R(void 0,(e=>{g.memory.stateConfig.rearray||e.next()}));function $(e,t){g.tagUse.forEach((r=>r.beforeRender(e,t)))}function F(e,t){g.tagUse.forEach((r=>r.afterRender(e,t))),P.next(t)}const N=[];var _;!function(e){e.tag="tag",e.tagArray="tag-array",e.tagComponent="tag-component",e.value="value"}(_||(_={}));const U="__tagvar",I="--"+U+"--";function J(e,t){const r=t.getAttribute("props");if(r){const n=t.gateway,o=(W[e]||n.tagGateway).propMemory[r];return V(t,o.props),o}const n=t.getAttribute("propsJson");if(n){const e=JSON.parse(n);return V(t,e),{props:e,callCount:0}}const o=t.getAttributeNames().reduce(((e,r)=>{const n=r.split(":");let o=t.getAttribute(r);return n.length>1&&("number"===n[1]&&(o=Number(o)),r=n[0]),e[r]=o,e}),{});return delete o.tag,V(t,o),{props:o,callCount:0}}function V(e,t){const r=e.getAttribute("events");r&&r.split(",").map((e=>e.trim())).map((e=>{t[e]=t=>n(e,{detail:{[e]:t}})}));const n=function(t,r){const n=new CustomEvent(t,r);e.dispatchEvent(n)};return t}new RegExp(U,"g"),new RegExp(I,"g");const W={},B=function(e){const t=G(e);if(W[t])return W[t];let r,n=0;function o(){const n=function(e,t){return function(e,t,r){return t.forEach((t=>H(e,t,r))),t}(e,document.querySelectorAll(`[tag="${e}"]`),t)}(t,e);return n.length?(r&&clearInterval(r),delete W[t],n.length):n.length}const a={id:t,propMemory:{},props:(e,t)=>{const r=a.propMemory[e]=a.propMemory[e]||{props:t,callCount:0};r.props=t,++r.callCount;const{element:n,tag:o}=r;return n&&o&&a.updateTag(o,n),e},updateTag:(e,r)=>{!function(e,t,r){const n=r.tagSupport.templater,o=n.global.newest,a=o.tagSupport.propsConfig.latestCloned,s=J(e,t).props;JSON.stringify(a)!==JSON.stringify(s)&&(o.tagSupport.templater.props=s,P.toCallback((()=>{const e=n.global.newest.tagSupport;e.templater.props=s,v(e,!1)})))}(t,r,e)}};return o()?a:(r=setInterval((()=>{if(n+=5,n>=2e3)throw clearInterval(r),new Error(`TaggedJs Element ${t} not found`);o()}),5),W[t]=a,W[t])},D={};function L(e){const{id:t,observer:r,tag:n}=e;r.disconnect(),n.destroy(),delete D[t]}function G(e){return"__tagTemplate_"+function(e){let t=e.toString().replace(/\s+/g,"_").replace(/[^\w\d]/g,"_");return/^[a-zA-Z]/.test(t)||(t="fn_"+t),t}(e)}function H(e,t,r){const n=t.gateway;if(n)return n.updateTag(),n;const o=J(e,t),a=o.props;try{const{tag:n}=function(e,t,r){const n=N.findIndex((e=>e.element===t));n>=0&&(N[n].tag.destroy(),N.splice(n,1),console.warn("Found and destroyed app element already rendered to element",{element:t}));const o=e(r),a=function(e){const t=new M({}),r=new l(e,t);e.tagSupport=r,$(r,void 0);const n=e.wrapper(r,t);return F(r,n),{tag:n,tagSupport:r}}(o),{tag:s}=a;s.appElement=t,s.tagSupport.templater.global.isApp=!0;const i=document.createElement("template");if(i.setAttribute("id","app-tag-"+N.length),i.setAttribute("app-tag-detail",N.length.toString()),t.appendChild(i),s.buildBeforeElement(i),o.global.oldest=s,o.global.newest=s,!s.hasLiveElements)throw new Error("x");return t.setUse=e.original.setUse,N.push({element:t,tag:s}),{tag:s,tags:e.original.tags}}(r,t,a);return o.element=t,o.tag=n,function(e,t,r,n){const o=W[e],a=new MutationObserver((e=>{if(function(e){const{element:t}=e;return!!document.body.contains(t)||(L(e),!1)}(l))for(const t of e)"attributes"===t.type&&s()}));function s(){o.updateTag(r,t)}Z(n);const l={id:e,tag:r,observer:a,component:n,element:t,updateTag:s,tagGateway:o};return D[e]=D[e]||[],D[e].gates.push(l),t.gateway=l,a.observe(t,{attributes:!0}),l}(e,t,n,r)}catch(e){throw console.warn("Failed to render component to element",{component:r,element:t,props:a,err:e}),e}}class Y extends HTMLElement{gateway;constructor(){super(),setTimeout((()=>this.gateway=function(e){const t=e.gateway;let r=t?.id||e.getAttribute("tag");if(!r){const t='Tagged gateway element must have a "tag" attribute which describes which tag to use';throw console.warn(t,{element:e}),new Error(t)}if(!r){const t="Cannot check a tag on element with no id attribute";throw console.warn(t,{tagName:r,element:e}),new Error(t)}const n=D[r].tagComponent;if(!n){const t=`Cannot find a tag registered by id of ${r}`;throw console.warn(t,{tagName:r,element:e}),new Error(t)}return H(r,e,n)}(this)),0)}disconnectedCallback(){L(this.gateway)}}const q="tag-element";function z(){customElements.define(q,Y)}let K=!1;function Z(e){if(!K){try{z()}catch(e){throw e}K=!0}const t=G(e);return D[t]=D[t]||{gates:[],tagComponent:e},D[t].tagComponent=e,t}var Q=t.xH,X=t.Ly,ee=t.TY;export{Q as initWebComponents,X as loadTagGateway,ee as tagGateway};